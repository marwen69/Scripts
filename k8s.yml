---
- name: Deploy Kubernetes Cluster
  hosts: all
  become: yes
  vars:
    kube_version: "1.29.2"
    pod_network_cidr: "10.244.0.0/16"
  order: sorted
  serial: 1

  handlers:
    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted

    - name: Reboot system
      reboot:
        msg: "Reboot required for kernel changes"
        reboot_timeout: 600
      when: reboot_required | default(false)

  tasks:
    - name: Configure all nodes
      include_tasks: tasks/common.yml

    - name: Configure master nodes
      include_tasks: tasks/master.yml
      when: inventory_hostname in groups.master

    - name: Configure worker nodes
      include_tasks: tasks/worker.yml
      when: inventory_hostname in groups.workers

  post_tasks:
    - name: Ensure kubectl is installed on master
      shell: command -v kubectl
      register: kubectl_check
      changed_when: false
      failed_when: kubectl_check.rc != 0
      delegate_to: "{{ groups.master[0] }}"
      run_once: yes

    - name: Apply RBAC fix (if necessary)
      shell: |
        kubectl create clusterrolebinding cluster-admin-binding \
          --clusterrole=cluster-admin \
          --user=system:serviceaccount:kube-system:default
      delegate_to: "{{ groups.master[0] }}"
      run_once: yes
      ignore_errors: yes
      when: kubectl_check.rc == 0

    - name: Verify cluster health
      shell: |
        kubectl get nodes && kubectl get pods -n kube-system
      register: cluster_health
      until: cluster_health.rc == 0
      retries: 10
      delay: 30
      delegate_to: "{{ groups.master[0] }}"
      run_once: yes
      when: kubectl_check.rc == 0

    - name: Show final status
      debug:
        msg: "Kubernetes cluster deployed successfully! Nodes:\n{{ cluster_health.stdout }}"
      run_once: yes
      when: cluster_health.rc == 0
