- name: Install required packages
  block:
    - name: Install containerd
      yum:
        name: containerd
        state: present

    - name: Enable and start containerd
      systemd:
        name: containerd
        enabled: yes
        state: started

    - name: Configure containerd to use SystemdCgroup
      block:
        - name: Create containerd config directory
          file:
            path: /etc/containerd
            state: directory
        - name: Generate containerd default config
          command: containerd config default
          register: containerd_config
          changed_when: false
        - name: Apply SystemdCgroup setting
          copy:
            dest: /etc/containerd/config.toml
            content: "{{ containerd_config.stdout | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true') }}"
        - name: Restart containerd
          systemd:
            name: containerd
            state: restarted

- name: Install Kubernetes components
  block:
    - name: Add Kubernetes repo
      yum_repository:
        name: kubernetes
        description: Kubernetes RPM Repository
        baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
        gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg
        gpgcheck: yes
        enabled: yes

    - name: Install Kubernetes packages
      yum:
        name:
          - kubelet-1.32.0
          - kubeadm-1.32.0
          - kubectl-1.32.0
        state: present

    - name: Enable kubelet
      systemd:
        name: kubelet
        enabled: yes

- name: Initialize cluster
  block:
    - name: Create kubeadm config
      template:
        src: templates/kubeadm-config.j2
        dest: /tmp/kubeadm-config.yaml

    - name: Label master node
      command: kubectl label nodes {{ inventory_hostname }} node-role.kubernetes.io/master=""
      when: inventory_hostname in groups.master
      ignore_errors: yes

    - name: Initialize control plane
      command: >
        kubeadm init --config=/tmp/kubeadm-config.yaml
        --ignore-preflight-errors=Swap
        --upload-certs
      register: kubeadm_init
      args:
        creates: /etc/kubernetes/admin.conf

    - name: Configure kubectl
      shell: |
        mkdir -p $HOME/.kube
        cp -f /etc/kubernetes/admin.conf $HOME/.kube/config
        chown $(id -u):$(id -g) $HOME/.kube/config

    - name: Generate worker join command
      shell: |
        kubeadm token create --print-join-command > /tmp/join-command.sh
        chmod 644 /tmp/join-command.sh

    - name: Verify token
      shell: cat /tmp/join-command.sh

    - name: Install Flannel CNI
      shell: |
        kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

    - name: Verify join command creation
      shell: |
        [ -f /tmp/join-command.sh ] && grep -q "kubeadm join" /tmp/join-command.sh
      register: join_verify
      changed_when: false
      failed_when: join_verify.rc != 0
